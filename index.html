<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MathAdventure RPG (v3.5 Estable)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-900">
    <div id="root"></div>
    <script type="text/babel">
      const { useReducer, useEffect, useCallback, useRef, memo, useState } = React;

      // --- SVG Icons ---
      const IconSword = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 17.5 3 6V3h3l11.5 11.5"/><path d="m21 3-3.5 3.5"/><path d="M12.5 12.5 16 16"/><path d="m3 21 3.5-3.5"/><path d="M17 11 21 7"/></svg>;
      const IconBow = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.17 6.83A6 6 0 0 0 12 6a6 6 0 0 0-9.17 7.17"/><path d="M12 6v12"/><path d="m3 12.5 4-4"/><path d="m17 8.5 4 4"/><path d="m15 19-6-6"/><path d="m9 19-6-6"/></svg>;
      const IconVolume2 = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>;
      const IconVolumeX = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="22" y1="2" x2="16" y2="8"/><line x1="16" y1="2" x2="22" y2="8"/></svg>;
      const IconHeart = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" className="text-red-500"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>;
      const IconBrainCircuit = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A3 3 0 1 0 12 18Z"/><path d="M9 13a4.5 4.5 0 0 0 4.5 4.5 4.5 4.5 0 0 0 4.5-4.5V13A4.5 4.5 0 0 0 13.5 8.5 4.5 4.5 0 0 0 9 13Z"/><path d="M11.5 6.5v-2"/><path d="M9 9V8m-2 2.5H6"/><path d="m6.5 15.5-1-1"/><path d="M9 17v1"/><path d="m12 19.5 1-.5"/><path d="M15.5 17.5-1-1"/><path d="m18.5 14.5 1-1"/><path d="m18 12 1-1"/><path d="m17 9 1.5-1"/><path d="m14 7 1-1.5"/><path d="M11 9h-1"/><path d="m15 13-1 1"/><path d="m13 15 .5 1.5"/></svg>;
      const IconHome = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>;
      const IconGoldCoin = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-yellow-400"><circle cx="12" cy="12" r="8"></circle><path d="M12 18V6"></path><path d="M16 16c-1.5 0-3-1-3-3.5S13 9 16 9"></path></svg>;
      const IconSparkles = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.5 3L7 7.5l3 1.5L8.5 12l1.5 3 1.5-3 3-1.5-3-1.5z"/><path d="M19 13.5 17 12l-2 1.5 1.5 2L15 19l2-1.5 2 1.5-1.5-2z"/><path d="M5 6.5 3 5l-2 1.5 1.5 2L1 10l2-1.5 2 1.5-1.5-2z"/></svg>;
      const IconStore = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m2 7 4.41-4.41A2 2 0 0 1 7.83 2h8.34a2 2 0 0 1 1.42.59L22 7"/><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><path d="M15 22v-4a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v4"/><path d="M2 7h20"/><path d="M22 7l-2 5H4L2 7Z"/></svg>;
      const IconBook = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20v1.5A2.5 2.5 0 0 1 17.5 21H6.5A2.5 2.5 0 0 1 4 18.5V18.5z"/><path d="M4 7h16v10H4z"/><path d="M17.5 21a2.5 2.5 0 0 0 2.5-2.5V7A2.5 2.5 0 0 0 17.5 4.5h-11A2.5 2.5 0 0 0 4 7v11.5A2.5 2.5 0 0 0 6.5 21H10"/></svg>;
      const IconShield = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-sky-400"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>;

      // ================================================================================= //
      // CONFIGURACIÃ“N CENTRALIZADA DEL JUEGO                                              //
      // ================================================================================= //
      const mathAdventureConfig = {
        CHARACTERS: {
          mage: { id: "mage", name: "Mago MÃ­stico", emoji: "ğŸ§™", attackEmoji: "ğŸ”¥", attackType: "magic", description: "Maestro de las artes arcanas.", color: "purple", ability: { name: "Bola de Fuego", description: "Resuelve el problema actual." } },
          knight: { id: "knight", name: "Caballero Valiente", emoji: "ğŸ¤º", attackEmoji: <IconSword />, attackType: "sword", description: "Guerrero audaz con armadura.", color: "sky", ability: { name: "Escudo Divino", description: "El prÃ³ximo error no te harÃ¡ daÃ±o." } },
          princess: { id: "princess", name: "Princesa Arquera", emoji: "ğŸ‘¸", attackEmoji: <IconBow />, attackType: "bow", description: "Realeza con precisiÃ³n letal.", color: "emerald", ability: { name: "Flecha Certera", description: "AÃ±ade 5 segundos al reloj." } },
          fairy: { id: "fairy", name: "Hada Sanadora", emoji: "ğŸ§š", attackEmoji: "âœ¨", attackType: "magic", description: "Poderes de la naturaleza y luz.", color: "pink", ability: { name: "BendiciÃ³n", description: "Restaura una vida." } },
        },
        SHOP_ITEMS: { 
            hat: { id: 'hat', name: 'Sombrero de Mago', price: 1000, emoji: 'ğŸ©', style: { top: '-2rem', fontSize: '3rem', transform: 'translateX(-50%) rotate(-15deg)', left: '50%'} }, 
            glasses: { id: 'glasses', name: 'Gafas de Sol', price: 1500, emoji: 'ğŸ•¶ï¸', style: { top: '1.5rem', fontSize: '1.5rem', transform: 'translateX(-50%)', left: '50%'} }, 
            crown: { id: 'crown', name: 'Corona Real', price: 2500, emoji: 'ğŸ‘‘', style: { top: '-1.2rem', fontSize: '2.5rem', transform: 'translateX(-50%)', left: '50%'} },
            wand: { id: 'wand', name: 'Varita MÃ¡gica', price: 3000, emoji: 'ğŸª„', style: { right: '-1.5rem', top: '1rem', fontSize: '2rem', transform: 'rotate(25deg)'} },
            pumpkin: { id: 'pumpkin', name: 'Calabaza Halloween', price: 500, emoji: 'ğŸƒ', style: { left: '-1.5rem', bottom: '0rem', fontSize: '2rem' } },
            santa_hat: { id: 'santa_hat', name: 'Gorro NavideÃ±o', price: 500, emoji: 'ğŸ…', style: { top: '-3rem', fontSize: '6rem', transform: 'translateX(-50%)', left: '50%', zIndex: -1 } },
        },
        LEVEL_CONFIG: { 1: { title: "Bosque de la Suma", operation: "+", range: [1, 10], enemies: 15, enemy: { name: "Goblin", emoji: "ğŸ‘º", attackEmoji: "æ£" }, boss: { name: "Rey Goblin", emoji: "ğŸ‘¹", health: 5 }, theme: { bg: "from-green-500 to-emerald-600", musicKey: "C" } }, 2: { title: "Cueva de la Resta", operation: "-", range: [10, 25], enemies: 15, enemy: { name: "MurciÃ©lago", emoji: "ğŸ¦‡", attackEmoji: "ğŸ”Š" }, boss: { name: "MurciÃ©lago Antiguo", emoji: "ğŸ§›", health: 4 }, theme: { bg: "from-indigo-500 to-purple-600", musicKey: "D" } }, 3: { title: "Forja de Factores", operation: "Ã—", range: [2, 10], enemies: 15, enemy: { name: "Orco", emoji: "ğŸ¦", attackEmoji: "ğŸ”¨" }, boss: { name: "Jefe Orco", emoji: "ğŸ¦§", health: 5 }, theme: { bg: "from-slate-600 to-gray-800", musicKey: "E" } }, 4: { title: "Colinas de Cifras", operation: "+", range: [10, 50], enemies: 15, enemy: { name: "JabalÃ­", emoji: "ğŸ—", attackEmoji: "ğŸ’¨" }, boss: { name: "JabalÃ­ Mayor", emoji: "ğŸ–", health: 4 }, theme: { bg: "from-lime-500 to-yellow-600", musicKey: "F" } }, 5: { title: "Pantano Diferencial", operation: "-", range: [20, 100], enemies: 15, enemy: { name: "Serpiente", emoji: "ğŸ", attackEmoji: "ğŸ§ª" }, boss: { name: "Hidra del Pantano", emoji: "ğŸ‰", health: 5 }, theme: { bg: "from-teal-500 to-cyan-600", musicKey: "G" } }, 6: { title: "Castillo del Producto", operation: "Ã—", range: [5, 12], enemies: 15, enemy: { name: "Caballero Oscuro", emoji: "ğŸ’‚", attackEmoji: <IconSword/> }, boss: { name: "Lord Multiplicador", emoji: "ğŸ¤´", health: 6 }, theme: { bg: "from-neutral-700 to-stone-900", musicKey: "A" } }, 7: { title: "Picos AritmÃ©ticos", operation: "+", range: [50, 200], enemies: 15, enemy: { name: "Golem", emoji: "ğŸ—¿", attackEmoji: "ğŸ§±" }, boss: { name: "Golem Ancestral", emoji: "ğŸ›ï¸", health: 5 }, theme: { bg: "from-orange-500 to-red-600", musicKey: "C" } }, 8: { title: "Glaciar Negativo", operation: "-", range: [100, 500], enemies: 15, enemy: { name: "Lobo de Hielo", emoji: "ğŸº", attackEmoji: "â„ï¸" }, boss: { name: "Fenrir", emoji: "ğŸ•â€", health: 6 }, theme: { bg: "from-sky-400 to-blue-600", musicKey: "D" } }, 9: { title: "Torre de Tablas", operation: "Ã—", range: [2, 20], enemies: 15, enemy: { name: "GÃ¡rgola", emoji: "ğŸ¦‡", attackEmoji: "ğŸª¨" }, boss: { name: "GÃ¡rgola Soberana", emoji: "ğŸ§›", health: 7 }, theme: { bg: "from-rose-800 to-purple-900", musicKey: "E" } }, 10: { title: "VolcÃ¡n de la DivisiÃ³n", operation: "Ã·", range: [2, 15], enemies: 15, enemy: { name: "Espectro de Fuego", emoji: "ğŸ”¥", attackEmoji: "â˜„ï¸" }, boss: { name: "TitÃ¡n VolcÃ¡nico", emoji: "ğŸŒ‹", health: 8 }, theme: { bg: "from-red-800 to-black", musicKey: "G" } }, },
        TIMER_DURATIONS: { campaign: 12, practice: 12, heroic: 10 },
        generateProblem: (level, LEVEL_CONFIG) => {
            const config = LEVEL_CONFIG[level];
            const [min, max] = config.range;
            let num1, num2;
            switch (config.operation) {
                case "+": num1 = Math.floor(Math.random() * (max - min + 1)) + min; num2 = Math.floor(Math.random() * (max - min + 1)) + min; return { question: `${num1} + ${num2}`, answer: num1 + num2 };
                case "-": num1 = Math.floor(Math.random() * (max - min + 1)) + min; num2 = Math.floor(Math.random() * (max - min + 1)) + min; if (num1 < num2) [num1, num2] = [num2, num1]; return { question: `${num1} - ${num2}`, answer: num1 - num2 };
                case "Ã—": num1 = Math.floor(Math.random() * (max - min + 1)) + min; num2 = Math.floor(Math.random() * 9) + 2; return { question: `${num1} Ã— ${num2}`, answer: num1 * num2 };
                case "Ã·": const divisor = Math.floor(Math.random() * 11) + 2; const respuesta = Math.floor(Math.random() * (max - min + 1)) + min; const dividendo = divisor * respuesta; return { question: `${dividendo} Ã· ${divisor}`, answer: respuesta };
                default: return { question: "1 + 1", answer: 2 };
            }
        },
        LESSONS: {
          sum: { 
              id: 'sum', 
              title: 'El Puente a la Decena',
              examples: [
                  [{ text: 'Para un problema como:', viz: '28 + 45' }, { text: 'Es mÃ¡s fÃ¡cil si uno de los nÃºmeros termina en cero. El 28 necesita 2 para llegar a 30.', viz: '28 + 2 = 30' }, { text: 'El 45 le "presta" ese 2. AsÃ­ que ahora tenemos:', viz: '30 + 43' }, { text: 'Â¡Mucho mÃ¡s fÃ¡cil! El resultado es:', viz: '73' }],
                  [{ text: 'Veamos otro caso:', viz: '37 + 58' }, { text: 'El 58 estÃ¡ cerca de 60. Necesita 2.', viz: '58 + 2 = 60' }, { text: 'El 37 le "presta" ese 2. La operaciÃ³n se transforma en:', viz: '35 + 60' }, { text: 'Â¡Sencillo! El resultado es:', viz: '95' }],
                  [{ text: 'Un Ãºltimo ejemplo:', viz: '19 + 64' }, { text: 'El 19 solo necesita 1 para llegar a 20.', viz: '19 + 1 = 20' }, { text: 'El 64 le "presta" ese 1. Ahora la suma es:', viz: '20 + 63' }, { text: 'Â¡Listo! El resultado es:', viz: '83' }]
              ]
          },
          multiply: { 
              id: 'multiply', 
              title: 'Rompiendo NÃºmeros Grandes',
              examples: [
                [{ text: 'Para multiplicar:', viz: '13 x 8' }, { text: 'Es mÃ¡s fÃ¡cil "romper" el 13 en partes:', viz: '10 y 3' }, { text: 'Luego, multiplica cada parte por 8:', viz: '(10 x 8) y (3 x 8)' }, { text: 'Resuelve esas partes, que son mÃ¡s fÃ¡ciles:', viz: '80 y 24' }, { text: 'Y al final, solo suma los resultados:', viz: '80 + 24 = 104' }],
                [{ text: 'Intentemos con este:', viz: '15 x 6' }, { text: 'Rompemos el 15 en:', viz: '10 y 5' }, { text: 'Multiplicamos cada parte por 6:', viz: '(10 x 6) y (5 x 6)' }, { text: 'Resolvemos:', viz: '60 y 30' }, { text: 'Â¡Y sumamos para el resultado final!', viz: '60 + 30 = 90' }],
                [{ text: 'Uno mÃ¡s grande:', viz: '24 x 5' }, { text: 'Rompemos el 24 en:', viz: '20 y 4' }, { text: 'Multiplicamos cada parte por 5:', viz: '(20 x 5) y (4 x 5)' }, { text: 'Resolvemos:', viz: '100 y 20' }, { text: 'Â¡Y el resultado es la suma!', viz: '100 + 20 = 120' }]
              ]
          },
          subtract: { 
              id: 'subtract', 
              title: 'El PrÃ©stamo Amigable',
              examples: [
                [{ text: 'Para una resta como:', viz: '54 - 9' }, { text: 'Restar 9 es difÃ­cil. Â¡Restar 10 es fÃ¡cil!', viz: '54 - 10 = 44' }, { text: 'Pero quitaste 1 de mÃ¡s... asÃ­ que debes devolverlo.', viz: '44 + 1' }, { text: 'Â¡Y ahÃ­ estÃ¡! La respuesta es:', viz: '45' }],
                [{ text: 'Probemos con:', viz: '73 - 8' }, { text: 'En lugar de 8, restemos 10.', viz: '73 - 10 = 63' }, { text: 'Como 8 es 2 menos que 10, devuÃ©lvele 2.', viz: '63 + 2' }, { text: 'Â¡El resultado correcto es:', viz: '65' }],
                [{ text: 'Un Ãºltimo caso:', viz: '41 - 7' }, { text: 'Otra vez, restamos 10.', viz: '41 - 10 = 31' }, { text: 'Como 7 es 3 menos que 10, le devolvemos 3.', viz: '31 + 3' }, { text: 'Â¡Y la respuesta es:', viz: '34' }]
              ]
          },
        }
      };

      // --- Audio Manager ---
      const audioManager = { isInitialized: false, synths: {}, reverb: null, async init() { if (this.isInitialized || typeof window.Tone === 'undefined') return; await window.Tone.start(); this.isInitialized = true; Tone.Master.volume.value = -12; this.reverb = new Tone.Reverb(0.75).toDestination(); this.synths.sword = new Tone.MetalSynth({ volume: -12 }).connect(this.reverb); this.synths.magic = new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 6, envelope: { attack: 0.001, decay: 0.2, release: 0.01 }, volume: -8 }).connect(this.reverb); this.synths.bow = new Tone.NoiseSynth({ noise: { type: 'white' }, envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 }, volume: -18 }).connect(this.reverb); this.synths.playerHit = new Tone.MembraneSynth({ pitchDecay: 0.05, octaves: 10, volume: -5 }).toDestination(); this.synths.enemyHit = new Tone.MembraneSynth({ pitchDecay: 0.08, octaves: 5, volume: -8 }).toDestination(); this.synths.melody = new Tone.Synth({ volume: -8, envelope: { attack: 0.01, decay: 0.2, release: 0.2 } }).connect(this.reverb); this.synths.click = new Tone.MembraneSynth({ volume: -20 }).toDestination(); this.synths.chaChing = new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.001, decay: 0.1, release: 0.1 }, volume: -10 }).toDestination(); this.synths.powerUp = new Tone.Synth({ envelope: { attack: 0.01, decay: 0.3, release: 0.2 }, volume: -6 }).toDestination(); this.synths.musicLead = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "triangle" }, envelope: { attack: 0.02, decay: 0.1, sustain: 0.3, release: 1 }, volume: -18 }).connect(this.reverb); this.synths.musicBass = new Tone.MonoSynth({ oscillator: { type: "fatsawtooth" }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.5, release: 1 }, volume: -16 }).connect(this.reverb); }, playSound(sound) { if (!this.isInitialized) return; const now = Tone.now(); switch (sound) { case 'sword': this.synths.sword.triggerAttackRelease("C4", "8n", now); break; case 'magic': this.synths.magic.triggerAttackRelease("G5", "8n", now); break; case 'bow': this.synths.bow.triggerAttackRelease("8n", now); break; case 'playerHit': this.synths.playerHit.triggerAttackRelease("C2", "8n", now); break; case 'enemyHit': this.synths.enemyHit.triggerAttackRelease("G3", "8n", now); break; case 'levelComplete': this.playMelody(['C5', 'E5', 'G5', 'C6']); break; case 'gameOver': this.playMelody(['C4', 'A3', 'F3', 'E3']); break; case 'click': this.synths.click.triggerAttackRelease("C3", "8n", now); break; case 'chaChing': this.synths.chaChing.triggerAttackRelease('E6', '16n', now); this.synths.chaChing.triggerAttackRelease('G6', '16n', now + 0.05); break; case 'powerUp': this.synths.powerUp.triggerAttackRelease('C5', '8n', now); this.synths.powerUp.triggerAttackRelease('G5', '8n', now + 0.1); this.synths.powerUp.triggerAttackRelease('C6', '8n', now + 0.2); break; } }, playMelody(notes) { if (!this.isInitialized) return; const now = Tone.now(); notes.forEach((note, i) => { this.synths.melody.triggerAttackRelease(note, "8n", now + i * 0.2); }); }, startMusic(key = "C", type = "menu") { if (!this.isInitialized) return; Tone.Transport.cancel(); let leadNotes, bassNotes; const G = Tone.Frequency(key + "3").transpose(7).toNote().replace('3', '4'); const C_low = key + '3'; if (type === "menu") { leadNotes = [`${key}4`, null, `${key}5`, null, G, null, `${key}4`, null]; bassNotes = [`${key}2`, null, null, null]; } else { leadNotes = [ `${key}4`, null, G, null, `${key}5`, null, G, null, `${key}4`, null, C_low.replace('3','4'), null, `${key}4`, G, `${key}3`, null ]; bassNotes = [ `${key}2`, null, null, null, G.replace('4','2'), null, null, null, C_low.replace('3','2'), null, null, null, G.replace('4','2'), null, `${key}2`, null ]; } new Tone.Sequence((time, note) => { if (note) this.synths.musicLead.triggerAttackRelease(note, "8n", time); }, leadNotes, "8n").start(0); new Tone.Sequence((time, note) => { if (note) this.synths.musicBass.triggerAttackRelease(note, "2n", time); }, bassNotes, "2n").start(0); Tone.Transport.start(); }, stopMusic() { if (!this.isInitialized) return; Tone.Transport.stop(); Tone.Transport.cancel(); } };

      // --- COMPONENTES DE UI MEMOIZADOS ---
      const CharacterSelectScreen = memo(({ config, onSelect, equippedItems }) => { const [selected, setSelected] = useState('mage'); const character = config.CHARACTERS[selected]; const backgroundClasses = { mage: 'from-purple-800 to-purple-900 border-purple-500', knight: 'from-sky-800 to-sky-900 border-sky-500', princess: 'from-emerald-800 to-emerald-900 border-emerald-500', fairy: 'from-pink-800 to-pink-900 border-pink-500',}; const buttonClasses = { mage: 'bg-purple-500', knight: 'bg-sky-500', princess: 'bg-emerald-500', fairy: 'bg-pink-500',}; const textClasses = { mage: 'text-purple-300', knight: 'text-sky-300', princess: 'text-emerald-300', fairy: 'text-pink-300',}
          return (<div className={`p-4 sm:p-8 rounded-2xl max-w-4xl w-full grid grid-cols-1 md:grid-cols-2 gap-8 bg-gradient-to-br border-2 transition-all duration-500 ${backgroundClasses[character.id]}`}><div><h2 className="text-3xl sm:text-4xl font-bold mb-4">Elige a tu HÃ©roe</h2><div className="grid grid-cols-2 gap-4">{Object.values(config.CHARACTERS).map(char => (<button key={char.id} onClick={() => { setSelected(char.id); audioManager.playSound('click'); }} className={`p-4 rounded-xl text-center transition-all duration-200 ${selected === char.id ? `${buttonClasses[char.id]} ring-4 ring-white` : `bg-black bg-opacity-20 hover:bg-opacity-40`}`}><div className="text-5xl sm:text-6xl relative inline-block">{char.emoji}{char.id === selected && equippedItems.map(itemId => <span key={itemId} className="absolute" style={config.SHOP_ITEMS[itemId].style}>{config.SHOP_ITEMS[itemId].emoji}</span>)}</div><div className="font-semibold mt-2 text-sm sm:text-base">{char.name}</div></button>))}</div></div><div className="flex flex-col items-center justify-center text-center"><div className="text-8xl sm:text-9xl mb-4 transition-transform duration-300 transform hover:scale-110 relative">{character.emoji}{equippedItems.map(itemId => <span key={itemId} className="absolute" style={config.SHOP_ITEMS[itemId].style}>{config.SHOP_ITEMS[itemId].emoji}</span>)}</div><h3 className={`text-2xl sm:text-3xl font-bold ${textClasses[character.id]}`}>{character.name}</h3><p className="mt-2 text-base sm:text-lg opacity-80">{character.description}</p><button onClick={() => onSelect(selected)} className="mt-8 w-full bg-white text-gray-900 font-bold py-3 sm:py-4 px-8 rounded-xl text-lg sm:text-xl hover:bg-gray-200 transition-all transform hover:scale-105">Â¡Comenzar Aventura!</button></div></div>); });
      const LevelSelectScreen = memo(({ config, scores, onStartLevel, onBack, mode }) => { const highestCompleted = Object.keys(scores).reduce((max, key) => Math.max(max, parseInt(key.split('_')[1])), 0); return (<div className="p-4 md:p-8 animate-fade-in"><div className="flex justify-between items-center mb-8"><h1 className="text-3xl md:text-4xl font-bold">{mode === 'campaign' ? 'Modo CampaÃ±a' : 'Modo PrÃ¡ctica'}</h1><button onClick={onBack} className="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg">Volver</button></div><div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">{Object.entries(config.LEVEL_CONFIG).map(([levelStr, levelConfig]) => { const level = parseInt(levelStr); const isUnlocked = mode === 'practice' || level <= highestCompleted + 1; const score = scores[`level_${level}`] || 0; return (<div key={level} className={`rounded-2xl border-2 transition-all duration-300 ${isUnlocked ? `border-purple-500 hover:border-yellow-300 hover:shadow-2xl hover:shadow-purple-500/30` : 'border-gray-700'}`}><div className={`p-6 rounded-t-xl bg-gradient-to-br ${isUnlocked ? levelConfig.theme.bg : 'from-gray-800 to-gray-900'}`}><div className="flex justify-between items-center"><h3 className="text-2xl font-bold">{levelConfig.title}</h3><span className="text-4xl">{isUnlocked ? levelConfig.enemy.emoji : "â“"}</span></div><div className="mt-4 text-sm font-semibold opacity-80">PuntuaciÃ³n Max: {score}</div></div><div className="bg-gray-800 p-4 rounded-b-xl"><button onClick={() => isUnlocked && onStartLevel(level)} disabled={!isUnlocked} className="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-xl transition-all disabled:bg-gray-600 disabled:cursor-not-allowed enabled:hover:bg-purple-500 enabled:hover:scale-105">{isUnlocked ? (mode === 'practice' ? 'Practicar' : 'Jugar') : "Bloqueado"}</button></div></div>); })}</div></div>); });
      const StoreScreen = memo(({ config, gold, purchasedItems, equippedItems, onPurchase, onToggleEquip, onBack }) => { return (<div className="p-4 md:p-8 animate-fade-in"><div className="flex justify-between items-center mb-8"><h1 className="text-3xl md:text-4xl font-bold">Tienda de Accesorios</h1><div className="flex items-center gap-4"><div className="flex items-center gap-2 bg-black/30 p-2 rounded-lg"><IconGoldCoin /><span className="text-xl font-bold">{gold}</span></div><button onClick={onBack} className="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg">Volver</button></div></div><div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">{Object.values(config.SHOP_ITEMS).map(item => { const isPurchased = purchasedItems.includes(item.id); const isEquipped = equippedItems.includes(item.id); return (<div key={item.id} className="bg-gray-800 rounded-2xl p-6 text-center border-2 border-indigo-500/50 flex flex-col justify-between"><div className="flex-grow"><div className="text-7xl mb-4 relative inline-block">{item.emoji}<span className="absolute text-5xl opacity-30" style={{...item.style, zIndex: -1}}>ğŸ§™</span></div><h2 className="text-2xl font-bold">{item.name}</h2><div className="flex items-center justify-center gap-2 my-4"><IconGoldCoin /><span className="text-xl font-bold">{item.price}</span></div></div><div>{isPurchased ? (isEquipped ? <button onClick={() => onToggleEquip(item.id)} className="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-3 rounded-xl">Quitar</button> : <button onClick={() => onToggleEquip(item.id)} className="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-xl">Equipar</button>) : (<button onClick={() => onPurchase(item)} disabled={gold < item.price} className="w-full bg-indigo-600 hover:bg-indigo-500 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-bold py-3 rounded-xl">Comprar</button>)}</div></div>)})}</div></div>)});
      const ModeSelectScreen = memo(({ userName, onModeSelect, onCharacterChange, onStore, onLessons }) => { return (<div className="p-4 md:p-8 flex flex-col items-center justify-center h-full animate-fade-in"><h1 className="text-4xl md:text-5xl font-bold text-center mb-2">Â¡Hola, {userName}!</h1><p className="text-lg md:text-xl text-center opacity-80 mb-12">Elige tu modo de aventura.</p><div className="grid grid-cols-1 md:grid-cols-3 gap-6 md:gap-8 w-full max-w-4xl"> <button onClick={() => onModeSelect('campaign')} className="p-6 md:p-8 rounded-2xl bg-green-800/50 hover:bg-green-700/80 border-2 border-green-500 transition-all transform hover:scale-105"><h2 className="text-2xl md:text-3xl font-bold mb-2">CampaÃ±a</h2><p>La aventura principal. Desbloquea niveles y salva el reino.</p></button> <button onClick={() => onModeSelect('practice')} className="p-6 md:p-8 rounded-2xl bg-sky-800/50 hover:bg-sky-700/80 border-2 border-sky-500 transition-all transform hover:scale-105"><h2 className="text-2xl md:text-3xl font-bold mb-2">PrÃ¡ctica</h2><p>Repite cualquier nivel para mejorar tus habilidades.</p></button> <button onClick={() => onModeSelect('heroic')} className="p-6 md:p-8 rounded-2xl bg-red-800/50 hover:bg-red-700/80 border-2 border-red-500 transition-all transform hover:scale-105"><h2 className="text-2xl md:text-3xl font-bold mb-2">Heroico</h2><p>Completa todos los niveles con 3 vidas y sin poderes.</p></button></div><div className="flex gap-4 mt-12"><button onClick={onCharacterChange} className="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg">Cambiar Personaje</button><button onClick={onLessons} className="bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 px-6 rounded-lg"><IconBook className="inline-block" /> Lecciones</button><button onClick={onStore} className="bg-yellow-600 hover:bg-yellow-500 text-black font-bold py-2 px-6 rounded-lg"><IconStore className="inline-block" /> Tienda</button></div></div>); });
      const VictoryScreen = memo(({ config, score, livesBonus, totalScore, onAction, mode, level }) => { return (<div className="p-8 rounded-2xl bg-gradient-to-br from-yellow-800 to-amber-900 border-2 border-yellow-500 relative overflow-hidden"><div className="absolute inset-0 opacity-10 animate-spin-slow pointer-events-none"><IconSparkles className="w-full h-full" /></div><div className="text-8xl mb-4">ğŸ†</div><h2 className="text-4xl font-bold mb-4">{mode === 'heroic' ? 'Â¡Modo Heroico Completado!' : 'Â¡Nivel Completado!'}</h2><div className="bg-black/30 rounded-lg p-4 my-4 text-left space-y-2 text-lg"><div className="flex justify-between"><span>PuntuaciÃ³n Base:</span> <span>{score} pts</span></div><div className="flex justify-between"><span>Bonus por Vidas (â¤ï¸ x 100):</span> <span>{livesBonus} pts</span></div><hr className="border-yellow-400/50" /><div className="flex justify-between font-bold text-xl"><span>PuntuaciÃ³n Total:</span> <span>{totalScore} pts</span></div></div><div className="flex flex-wrap justify-center gap-4 my-4">{level < Object.keys(config.LEVEL_CONFIG).length && mode !== 'heroic' && <button onClick={() => onAction('next')} className="bg-green-600 hover:bg-green-500 py-3 px-6 rounded-lg font-bold">Siguiente Nivel</button>}{mode !== 'heroic' && <button onClick={() => onAction('replay')} className="bg-yellow-600 hover:bg-yellow-500 py-3 px-6 rounded-lg font-bold">Reintentar</button>}<button onClick={() => onAction('menu')} className="bg-gray-600 hover:bg-gray-500 py-3 px-6 rounded-lg font-bold">MenÃº Principal</button></div></div>); });
      const GameUI = memo(({ config, player, enemy, problem, userAnswer, onAnswerChange, onAttack, onAbility, feedback, isPlayerTurn, isBoss, correctStreak, abilityReady, floatingTexts, xp, totalXp, projectile, timerDuration, gameMode, equippedItems, isShielded, abilityUsed, timeLeft, onTimerTick }) => { useEffect(() => { const timer = setInterval(onTimerTick, 1000); return () => clearInterval(timer); }, []); const timePercentage = (timeLeft / timerDuration) * 100; const timeColor = timePercentage > 50 ? 'bg-green-500' : timePercentage > 25 ? 'bg-yellow-500' : 'bg-red-500'; const xpPercentage = (xp / totalXp) * 100; return (<div className="flex flex-col h-full justify-between p-4 relative">{floatingTexts.map(text => (<div key={text.id} style={{left: text.x, top: text.y}} className={`absolute font-bold text-2xl animate-float-up ${text.type === 'damage' ? 'text-red-500' : 'text-yellow-300'}`}>{text.text}</div>))}<div className="grid grid-cols-2 gap-4"><div><div className="flex items-center gap-2 mb-2"><span className="text-3xl relative">{player.character.emoji}{equippedItems.map(itemId => <span key={itemId} className="absolute" style={{...config.SHOP_ITEMS[itemId].style, transform: `${config.SHOP_ITEMS[itemId].style.transform || ''} scale(0.4)`, left: '50%', top: '50%'}}>{config.SHOP_ITEMS[itemId].emoji}</span>)}</span><span className="font-bold text-sm sm:text-base">{player.character.name}</span></div><div className="flex items-center gap-1">{isShielded && <div className="mr-2 animate-pulse"><IconShield /></div>}{[...Array(player.health)].map((_, i) => <IconHeart key={i} />)}</div>{gameMode !== 'heroic' && <div className="flex items-center gap-1 mt-2">{[...Array(3)].map((_,i) => <div key={i} className={`w-4 h-4 rounded-full ${i < correctStreak ? 'bg-yellow-400' : 'bg-gray-600'}`}></div>)}</div>}</div><div className="text-right"><div className="flex items-center justify-end gap-2 mb-1"><span className="font-bold text-sm sm:text-base">{enemy.name}</span><span className="text-3xl">{enemy.emoji}</span></div>{isBoss ? ( <div className="h-6 bg-gray-700 rounded-full overflow-hidden border-2 border-red-800"><div className="h-full bg-red-500 transition-all duration-300" style={{width: `${(enemy.health / enemy.maxHealth) * 100}%`}}></div></div> ) : ( <div className="h-4 bg-gray-700 rounded-full overflow-hidden border-2 border-purple-800"><div className="h-full bg-purple-500 transition-all duration-300" style={{width: `${xpPercentage}%`}}></div></div> )}</div></div><div className="flex items-center justify-around my-4 sm:my-8 relative h-24 sm:h-32">{projectile && ( <div key={projectile.id} className={`absolute text-5xl transition-all duration-500 ease-in-out ${projectile.from === 'player' ? 'left-8 sm:left-16 animate-fly-right' : 'right-8 sm:right-16 animate-fly-left'}`}>{projectile.emoji}</div> )}<div className={`relative text-6xl sm:text-8xl transition-transform duration-300 ${player.isHit ? 'animate-shake' : ''}`}>{player.character.emoji}{equippedItems.map(itemId => <span key={itemId} className="absolute" style={config.SHOP_ITEMS[itemId].style}>{config.SHOP_ITEMS[itemId].emoji}</span>)}</div><div className="text-4xl sm:text-5xl font-bold">VS</div><div className={`text-6xl sm:text-8xl transition-transform duration-300 ${enemy.isHit ? 'animate-shake' : ''} ${isBoss ? 'sm:scale-150' : ''}`}>{enemy.emoji}</div></div><div className="bg-black bg-opacity-30 p-4 sm:p-6 rounded-2xl border-2 border-purple-500/50 text-center">{abilityReady && gameMode !== 'heroic' && (<button onClick={onAbility} className={`w-full mb-4 py-2 px-4 rounded-lg bg-yellow-500 hover:bg-yellow-400 text-black font-bold animate-pulse`}><IconSparkles className="inline-block mr-2" /> {player.character.ability.name}</button>)}{feedback && <div className={`mb-4 p-2 rounded-lg text-sm sm:text-base ${feedback.type === 'success' ? 'bg-green-500/20 text-green-300' : 'bg-red-500/20 text-red-300'}`}>{feedback.message}</div>}{isPlayerTurn && problem ? (<><div className="relative h-3 w-full bg-gray-700 rounded-full mb-4"><div className={`${timeColor} h-full rounded-full transition-all duration-1000 linear`} style={{width: `${timePercentage}%`}}></div><div className={`absolute top-0 left-1/2 -translate-x-1/2 -mt-6 text-xl font-bold ${abilityUsed === 'princessTime' ? 'animate-ping' : ''}`}>{timeLeft}</div></div><h2 className="text-3xl sm:text-4xl font-bold mb-4">{problem.question}</h2><form onSubmit={(e) => { e.preventDefault(); onAttack(); }}><input type="number" value={userAnswer} onChange={(e) => onAnswerChange(e.target.value)} className="text-2xl sm:text-3xl text-center w-36 sm:w-48 p-2 sm:p-3 rounded-xl border-2 border-purple-400 bg-gray-800 focus:outline-none focus:border-yellow-400 mb-4" placeholder="?" autoFocus /><button type="submit" className="block w-full bg-yellow-400 text-purple-900 font-bold py-3 px-8 rounded-xl text-lg sm:text-xl hover:bg-yellow-300 transition-all transform hover:scale-105">Â¡Atacar!</button></form></>) : <div className="text-xl sm:text-2xl animate-pulse">Preparando siguiente turno...</div> }</div></div>); });
      const LessonsScreen = memo(({ config, onBack }) => { const [selectedLessonId, setSelectedLessonId] = useState(Object.keys(config.LESSONS)[0]); const [currentExample, setCurrentExample] = useState(null); const [step, setStep] = useState(0); useEffect(() => { const lesson = config.LESSONS[selectedLessonId]; const randomExample = lesson.examples[Math.floor(Math.random() * lesson.examples.length)]; setCurrentExample(randomExample); setStep(0); }, [selectedLessonId, config.LESSONS]); const visibleSteps = currentExample ? currentExample.slice(0, step + 1) : []; const handleNext = () => { if (currentExample && step < currentExample.length - 1) { setStep(step + 1); } }; const handleSelectLesson = (lessonId) => { setSelectedLessonId(lessonId); }; if (!currentExample) return null; return (<div className="p-4 md:p-8 animate-fade-in"><div className="flex justify-between items-center mb-8"><h1 className="text-3xl md:text-4xl font-bold">Lecciones de SabidurÃ­a</h1><button onClick={onBack} className="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg">Volver</button></div><div className="grid grid-cols-1 md:grid-cols-3 gap-8"><div className="md:col-span-1 flex flex-col gap-2">{Object.values(config.LESSONS).map(l => (<button key={l.id} onClick={() => handleSelectLesson(l.id)} className={`p-4 rounded-lg text-left font-bold transition-colors ${selectedLessonId === l.id ? 'bg-purple-600 text-white' : 'bg-gray-800 hover:bg-gray-700'}`}>{l.title}</button>))}</div><div className="md:col-span-2 bg-gray-800 rounded-lg p-6 flex flex-col justify-between" style={{minHeight: '400px'}}><div className="flex-grow space-y-6">{visibleSteps.map((s, index) => (<div key={index} className="animate-fade-in flex items-start gap-4"><span className="text-5xl opacity-50">ğŸ§™</span><div><p className="text-lg leading-relaxed">{s.text}</p><div className="text-center text-3xl font-bold my-2 bg-black/20 p-3 rounded-lg">{s.viz}</div></div></div>))}</div><button onClick={handleNext} disabled={!currentExample || step >= currentExample.length - 1} className="w-full mt-6 bg-yellow-500 text-black font-bold py-3 rounded-lg hover:bg-yellow-400 disabled:bg-gray-600 disabled:cursor-not-allowed">Siguiente Paso</button></div></div></div>); });

      // --- useReducer ---
      const initialState = { isInitialized: false, gameState: "loading", gameMode: 'campaign', userName: "", scores: {}, gold: 0, purchasedItems: [], equippedItems: [], soundEnabled: true, selectedCharacterId: "mage", currentLevel: 1, playerHealth: 5, isShielded: false, correctStreak: 0, abilityReady: false, enemiesDefeated: 0, isBossBattle: false, enemyHealth: 1, enemyMaxHealth: 1, currentProblem: null, userAnswer: "", feedback: null, isPlayerTurn: true, isPlayerHit: false, isEnemyHit: false, projectile: null, floatingTexts: [], abilityUsed: null, timeLeft: 12, };
      function gameReducer(state, action) { switch (action.type) { case 'INITIALIZE_DATA': return { ...state, ...action.payload, isInitialized: true, gameState: action.payload.userName ? 'modeSelect' : 'name' }; case 'SET_GAME_STATE': return { ...state, gameState: action.payload }; case 'SET_USER_NAME': return { ...state, userName: action.payload }; case 'SELECT_CHARACTER': return { ...state, selectedCharacterId: action.payload, gameState: 'modeSelect' }; case 'SELECT_MODE': return { ...state, gameMode: action.payload, gameState: action.payload === 'heroic' ? 'playing' : 'levelSelect' }; case 'PURCHASE_ITEM': { const item = action.payload; if (state.gold >= item.price && !state.purchasedItems.includes(item.id)) { return { ...state, gold: state.gold - item.price, purchasedItems: [...state.purchasedItems, item.id], equippedItems: [...state.equippedItems, item.id] }; } return state; } case 'TOGGLE_EQUIP_ITEM': { const itemId = action.payload; const isEquipped = state.equippedItems.includes(itemId); if (isEquipped) { return { ...state, equippedItems: state.equippedItems.filter(id => id !== itemId) }; } else { return { ...state, equippedItems: [...state.equippedItems, itemId] }; } } case 'START_LEVEL': { const { level, mode, config } = action.payload; const timerDuration = config.TIMER_DURATIONS[mode]; return { ...state, gameMode: mode, currentLevel: level, playerHealth: mode === 'heroic' ? 3 : 5, enemiesDefeated: 0, isBossBattle: false, enemyHealth: 1, enemyMaxHealth: 1, feedback: null, currentProblem: config.generateProblem(level, config.LEVEL_CONFIG), isPlayerTurn: true, correctStreak: 0, abilityReady: false, isShielded: false, gameState: 'playing', timeLeft: timerDuration }; } case 'SET_USER_ANSWER': return { ...state, userAnswer: action.payload };
        case 'PROCESS_ATTACK': {
          const { isCorrect, isTimeout } = action.payload;
          if (isCorrect) {
            const newStreak = state.correctStreak + 1;
            return { ...state, userAnswer: '', feedback: { type: 'success', message: 'Â¡Golpe Certero!' }, isEnemyHit: true, enemyHealth: state.enemyHealth - 1, enemiesDefeated: state.enemiesDefeated + 1, correctStreak: newStreak, abilityReady: newStreak >= 3 ? true : state.abilityReady, isPlayerTurn: false };
          } else {
            const shielded = state.isShielded;
            const newHealth = shielded ? state.playerHealth : state.playerHealth - 1;
            return { ...state, userAnswer: '', feedback: { type: 'error', message: shielded ? 'Â¡Escudo Divino bloquea el daÃ±o!' : (isTimeout ? 'Â¡Se acabÃ³ el tiempo!' : 'Â¡Fallaste!') }, playerHealth: newHealth, isPlayerHit: !shielded, correctStreak: 0, abilityReady: false, isShielded: false, isPlayerTurn: false, gameState: newHealth <= 0 ? 'gameOver' : state.gameState };
          }
        }
        case 'TIMER_TICK': {
          if (!state.isPlayerTurn || state.gameState !== 'playing') return state;
          const newTimeLeft = state.timeLeft - 1;
          if (newTimeLeft <= 0) {
            return gameReducer(state, { type: 'PROCESS_ATTACK', payload: { isCorrect: false, isTimeout: true } });
          }
          return { ...state, timeLeft: newTimeLeft };
        }
        case 'USE_ABILITY': { const character = mathAdventureConfig.CHARACTERS[state.selectedCharacterId]; let updates = { abilityReady: false, correctStreak: 0 }; switch (character.id) { case 'mage': updates.userAnswer = state.currentProblem.answer.toString(); break; case 'knight': updates.isShielded = true; break; case 'fairy': updates.playerHealth = Math.min(5, state.playerHealth + 1); break; case 'princess': updates.abilityUsed = 'princessTime'; break; } return { ...state, ...updates }; } case 'CLEAR_ABILITY_FLAG': return { ...state, abilityUsed: null }; case 'LEVEL_TRANSITION': { const { config } = action.payload; const { isBossBattle, enemiesDefeated, currentLevel, enemyHealth } = state; const levelConfig = config.LEVEL_CONFIG[currentLevel]; if (isBossBattle && enemyHealth <= 0) { if (state.gameMode === 'heroic' && currentLevel < Object.keys(config.LEVEL_CONFIG).length) { return gameReducer(state, { type: 'START_LEVEL', payload: { level: currentLevel + 1, mode: 'heroic', config } }); } const baseScore = 500; const livesBonus = state.playerHealth * 100; const totalScore = baseScore + livesBonus; const levelKey = `level_${currentLevel}`; const finalScore = Math.max((state.scores[levelKey] || 0), totalScore); return { ...state, gameState: 'levelComplete', scores: { ...state.scores, [levelKey]: finalScore }, gold: state.gold + totalScore }; } let nextState = { ...state }; if (!isBossBattle && enemiesDefeated >= levelConfig.enemies) { nextState.isBossBattle = true; nextState.enemyHealth = levelConfig.boss.health; nextState.enemyMaxHealth = levelConfig.boss.health; } nextState.currentProblem = config.generateProblem(currentLevel, config.LEVEL_CONFIG); nextState.isPlayerTurn = true; nextState.timeLeft = config.TIMER_DURATIONS[state.gameMode]; nextState.feedback = null; return nextState; } case 'ADD_FLOATING_TEXT': return { ...state, floatingTexts: [...state.floatingTexts, action.payload] }; case 'REMOVE_FLOATING_TEXT': return { ...state, floatingTexts: state.floatingTexts.filter(t => t.id !== action.payload) }; case 'SET_PROJECTILE': return { ...state, projectile: action.payload }; case 'CLEAR_HITS': return { ...state, isPlayerHit: false, isEnemyHit: false }; case 'TOGGLE_SOUND': return { ...state, soundEnabled: !state.soundEnabled }; default: return state; } }
      
      // --- GameEngine ---
      const GameEngine = ({ config }) => { const [state, dispatch] = useReducer(gameReducer, initialState); const { gameState, isInitialized, soundEnabled } = state; useEffect(() => { const savedName = localStorage.getItem("mathAdv_userName") || ""; const savedScores = JSON.parse(localStorage.getItem("mathAdv_scores") || "{}"); const savedGold = parseInt(localStorage.getItem("mathAdv_gold") || "0"); const savedChar = localStorage.getItem("mathAdv_charId") || "mage"; const savedPurchased = JSON.parse(localStorage.getItem("mathAdv_purchased") || "[]"); const savedEquipped = JSON.parse(localStorage.getItem("mathAdv_equipped") || "[]"); dispatch({ type: 'INITIALIZE_DATA', payload: { userName: savedName, scores: savedScores, gold: savedGold, selectedCharacterId: savedChar, purchasedItems: savedPurchased, equippedItems: savedEquipped } }); }, []); useEffect(() => { if(isInitialized) localStorage.setItem("mathAdv_userName", state.userName); }, [state.userName, isInitialized]); useEffect(() => { if(isInitialized) localStorage.setItem("mathAdv_scores", JSON.stringify(state.scores)); }, [state.scores, isInitialized]); useEffect(() => { if(isInitialized) localStorage.setItem("mathAdv_gold", state.gold.toString()); }, [state.gold, isInitialized]); useEffect(() => { if(isInitialized) localStorage.setItem("mathAdv_charId", state.selectedCharacterId); }, [state.selectedCharacterId, isInitialized]); useEffect(() => { if(isInitialized) localStorage.setItem("mathAdv_purchased", JSON.stringify(state.purchasedItems)); }, [state.purchasedItems, isInitialized]); useEffect(() => { if(isInitialized) localStorage.setItem("mathAdv_equipped", JSON.stringify(state.equippedItems)); }, [state.equippedItems, isInitialized]); const handleUserInteraction = useCallback(async () => { if (soundEnabled && !audioManager.isInitialized) { await audioManager.init(); if (['modeSelect', 'name', 'characterSelect', 'store', 'lessons'].includes(gameState)) { audioManager.startMusic(config.LEVEL_CONFIG[1].musicKey, "menu"); } } document.removeEventListener('click', handleUserInteraction); }, [soundEnabled, gameState, config]); useEffect(() => { document.addEventListener('click', handleUserInteraction); return () => document.removeEventListener('click', handleUserInteraction); }, [handleUserInteraction]); useEffect(() => { if (!audioManager.isInitialized) return; if (!soundEnabled) { audioManager.stopMusic(); } else { if (['modeSelect', 'name', 'characterSelect', 'store', 'lessons'].includes(gameState)) { audioManager.startMusic(config.LEVEL_CONFIG[1].musicKey, "menu"); } else if (gameState === 'playing') { audioManager.startMusic(config.LEVEL_CONFIG[state.currentLevel].musicKey, state.isBossBattle ? 'boss' : 'level'); } else { audioManager.stopMusic(); } } }, [soundEnabled, gameState, state.currentLevel, state.isBossBattle, config]); useEffect(() => { if (!audioManager.isInitialized) return; if (gameState === 'levelComplete') audioManager.playSound('chaChing'); }, [gameState]); useEffect(() => { if(state.abilityReady) audioManager.playSound('powerUp'); }, [state.abilityReady]);
        
        const animationTimeoutRef = useRef(null);
        useEffect(() => {
          if (state.isPlayerTurn === false && state.gameState === 'playing') {
            if (animationTimeoutRef.current) clearTimeout(animationTimeoutRef.current);
            const isCorrect = state.feedback?.type === 'success';
            const runAnimationsAndTransition = () => {
              addFloatingText(isCorrect ? '+100' : '-1 â¤ï¸', isCorrect ? 'score' : 'damage', isCorrect ? 'enemy' : 'player');
              if (isCorrect) {
                  audioManager.playSound('enemyHit');
              }
              if (!isCorrect && !state.isShielded) {
                const enemyAttackEmoji = config.LEVEL_CONFIG[state.currentLevel].enemy.attackEmoji;
                dispatch({ type: 'SET_PROJECTILE', payload: { id: Date.now(), from: 'enemy', emoji: enemyAttackEmoji } });
                setTimeout(() => {
                  dispatch({ type: 'SET_PROJECTILE', payload: null });
                  audioManager.playSound('playerHit');
                }, 500);
              }
              animationTimeoutRef.current = setTimeout(() => {
                dispatch({ type: 'CLEAR_HITS' });
                if (state.gameState === 'gameOver') {
                   audioManager.playSound('gameOver');
                } else {
                   dispatch({ type: 'LEVEL_TRANSITION', payload: { config } });
                }
              }, 1200);
            };
            setTimeout(() => {
                dispatch({ type: 'SET_PROJECTILE', payload: null }); // Limpia proyectil del jugador
                runAnimationsAndTransition();
            }, 500);
          }
          return () => clearTimeout(animationTimeoutRef.current);
        }, [state.feedback, state.isPlayerTurn, state.gameState]);

        const addFloatingText = useCallback((text, type, position) => { const id = Date.now() + Math.random(); const xPos = position === 'player' ? '25%' : '75%'; dispatch({type: 'ADD_FLOATING_TEXT', payload: {id, text, type, x: xPos, y: '40%'}}); setTimeout(() => dispatch({type: 'REMOVE_FLOATING_TEXT', payload: id}), 1500); }, []);
        const handleAttack = useCallback((isTimeout = false) => {
          if (!state.isPlayerTurn) return;
          const isCorrect = !isTimeout && parseInt(state.userAnswer) === state.currentProblem?.answer;
          dispatch({ type: 'SET_PROJECTILE', payload: { id: Date.now(), from: 'player', emoji: config.CHARACTERS[state.selectedCharacterId].attackEmoji } });
          audioManager.playSound(config.CHARACTERS[state.selectedCharacterId].attackType);
          dispatch({ type: 'PROCESS_ATTACK', payload: { isCorrect, isTimeout } });
        }, [state.isPlayerTurn, state.userAnswer, state.currentProblem, state.selectedCharacterId, config]);
        useEffect(() => { if (state.abilityUsed === 'princessTime') { setTimeout(() => dispatch({ type: 'CLEAR_ABILITY_FLAG' }), 100); } }, [state.abilityUsed]);
        const handleStartLevel = useCallback((level) => { audioManager.playSound('click'); dispatch({type: 'START_LEVEL', payload: {level, mode: state.gameMode, config}}); }, [state.gameMode, config]);
        const handleSelectCharacter = useCallback((charId) => { audioManager.playSound('levelComplete'); dispatch({ type: 'SELECT_CHARACTER', payload: charId }); }, []);
        const handleModeSelect = useCallback((mode) => { audioManager.playSound('click'); dispatch({ type: 'SELECT_MODE', payload: mode }); if (mode === 'heroic') { dispatch({ type: 'START_LEVEL', payload: { level: 1, mode: 'heroic', config }}); }}, [config]);
        const handleSetGameState = useCallback((newGameState) => { audioManager.playSound('click'); dispatch({ type: 'SET_GAME_STATE', payload: newGameState }); }, []);
        const handlePurchase = useCallback((item) => { audioManager.playSound('chaChing'); dispatch({ type: 'PURCHASE_ITEM', payload: item }); }, []);
        const handleToggleEquip = useCallback((itemId) => { audioManager.playSound('click'); dispatch({ type: 'TOGGLE_EQUIP_ITEM', payload: itemId }); }, []);
        const handleReturnToMenu = useCallback(() => handleSetGameState('modeSelect'), [handleSetGameState]);
        const handleEndScreenAction = useCallback((action) => { audioManager.playSound('click'); switch(action) { case 'next': handleStartLevel(state.currentLevel + 1); break; case 'replay': handleStartLevel(state.currentLevel); break; case 'menu': handleReturnToMenu(); break; } }, [state.currentLevel, handleStartLevel, handleReturnToMenu]);
        const handleAbility = useCallback(() => { if (!state.abilityReady) return; audioManager.playSound('levelComplete'); dispatch({type: 'USE_ABILITY'}); }, [state.abilityReady]);
        const bgGradient = gameState === 'playing' && config.LEVEL_CONFIG[state.currentLevel] ? `bg-gradient-to-br ${config.LEVEL_CONFIG[state.currentLevel].theme.bg}` : `bg-gradient-to-br from-gray-800 to-gray-900`;
        const renderOverlay = () => { const overlayContainerClass = "fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center text-center p-4 animate-fade-in z-50"; if (!isInitialized) return <div className="fixed inset-0 flex items-center justify-center bg-gray-900 z-50"><div className="text-center text-2xl animate-pulse">Cargando Aventura...</div></div>; switch (gameState) { case 'name': return <div className={`${overlayContainerClass} bg-opacity-90 backdrop-blur-sm`}><div className="p-8 rounded-2xl bg-gray-800 max-w-sm w-full text-center"><IconBrainCircuit className="mx-auto h-16 w-16 text-purple-400 mb-4" /><h2 className="text-3xl font-bold mb-4">Â¡Bienvenido a MathAdventure!</h2><input type="text" placeholder="Escribe tu nombre de hÃ©roe" value={state.userName} onKeyPress={(e) => {if(e.key === 'Enter' && state.userName.trim()) {handleSetGameState('characterSelect');}}} onChange={e => dispatch({type: 'SET_USER_NAME', payload: e.target.value})} className="w-full p-3 bg-gray-700 rounded-lg text-center text-xl"/><button disabled={!state.userName.trim()} onClick={() => handleSetGameState('characterSelect')} className="mt-4 w-full bg-purple-600 hover:bg-purple-500 py-3 rounded-lg font-bold text-xl disabled:bg-gray-500 disabled:cursor-not-allowed">Continuar</button></div></div>; case 'characterSelect': return <div className={overlayContainerClass}><CharacterSelectScreen config={config} onSelect={handleSelectCharacter} equippedItems={state.equippedItems} /></div>; case 'gameOver': return <div className={overlayContainerClass}><div className="p-8 rounded-2xl bg-red-900/50 border-red-500 border-2"><div className="text-8xl mb-4">â˜ ï¸</div><h2 className="text-4xl font-bold mb-4">Juego Terminado</h2><div className="flex flex-wrap justify-center gap-4 my-4"><button onClick={() => handleStartLevel(state.currentLevel)} className="bg-yellow-600 hover:bg-yellow-500 py-3 px-6 rounded-lg font-bold">Reintentar</button><button onClick={handleReturnToMenu} className="bg-gray-600 hover:bg-gray-500 py-3 px-6 rounded-lg font-bold">MenÃº Principal</button></div></div></div>; case 'levelComplete': const baseScore = 500; const livesBonus = state.playerHealth * 100; const totalScore = baseScore + livesBonus; return <div className={overlayContainerClass}><VictoryScreen config={config} score={baseScore} livesBonus={livesBonus} totalScore={totalScore} onAction={handleEndScreenAction} mode={state.gameMode} level={state.currentLevel} /></div>; default: return null; } }
        const renderMainContent = () => { switch(gameState) { case 'modeSelect': return <ModeSelectScreen userName={state.userName} onModeSelect={handleModeSelect} onCharacterChange={() => handleSetGameState('characterSelect')} onStore={() => handleSetGameState('store')} onLessons={() => handleSetGameState('lessons')} />; case 'levelSelect': return <LevelSelectScreen config={config} scores={state.scores} onStartLevel={handleStartLevel} mode={state.gameMode} onBack={handleReturnToMenu} />; case 'store': return <StoreScreen config={config} gold={state.gold} purchasedItems={state.purchasedItems} equippedItems={state.equippedItems} onPurchase={handlePurchase} onToggleEquip={handleToggleEquip} onBack={handleReturnToMenu} />; case 'lessons': return <LessonsScreen config={config} onBack={handleReturnToMenu} />; case 'playing': const levelConfig = config.LEVEL_CONFIG[state.currentLevel]; if (!levelConfig) return null; const enemyConfig = state.isBossBattle ? levelConfig.boss : levelConfig.enemy; return <GameUI config={config} player={{ character: config.CHARACTERS[state.selectedCharacterId], health: state.playerHealth, isHit: state.isPlayerHit }} enemy={{ ...enemyConfig, health: state.enemyHealth, maxHealth: state.enemyMaxHealth || 1, isHit: state.isEnemyHit }} problem={state.currentProblem} userAnswer={state.userAnswer} onAnswerChange={(val) => dispatch({type: 'SET_USER_ANSWER', payload: val})} onAttack={handleAttack} onAbility={handleAbility} feedback={state.feedback} isPlayerTurn={state.isPlayerTurn} isBoss={state.isBossBattle} xp={state.enemiesDefeated} totalXp={levelConfig.enemies} correctStreak={state.correctStreak} abilityReady={state.abilityReady} floatingTexts={state.floatingTexts} projectile={state.projectile} timerDuration={config.TIMER_DURATIONS[state.gameMode]} gameMode={state.gameMode} equippedItems={state.equippedItems} isShielded={state.isShielded} abilityUsed={state.abilityUsed} timeLeft={state.timeLeft} onTimerTick={() => dispatch({type: 'TIMER_TICK'})}/>; default: return null; } }
        return ( <div className={`min-h-screen text-white font-sans transition-colors duration-1000 ${bgGradient}`}> <div className="max-w-5xl mx-auto min-h-screen flex flex-col"> <header className="p-4 flex justify-between items-center bg-black bg-opacity-20 backdrop-blur-sm sticky top-0 z-10"><h1 className="text-xl sm:text-2xl font-bold">MathAdventure RPG</h1><div className="flex items-center gap-4">{ (gameState.includes('Select') || gameState === 'store' || gameState === 'lessons') && <div className="flex items-center gap-2 bg-black/30 p-2 rounded-lg"><IconGoldCoin /><span className="text-xl font-bold">{state.gold}</span></div> }{gameState === 'playing' && <button onClick={handleReturnToMenu} className="p-2 rounded-full hover:bg-white/10" title="Volver al menÃº"><IconHome /></button>}<button onClick={() => dispatch({type: 'TOGGLE_SOUND'})} className="p-2 rounded-full hover:bg-white/10">{soundEnabled ? <IconVolume2 /> : <IconVolumeX />}</button></div></header> <main className="flex-grow"> {renderMainContent()} </main> </div> {renderOverlay()} <style>{`body { font-family: 'Inter', sans-serif; } @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-8px) rotate(-2deg); } 75% { transform: translateX(8px) rotate(2deg); } } .animate-shake { animation: shake 0.4s; } @keyframes fly-right { from { transform: translateX(0); opacity: 1; } to { transform: translateX(calc(50vw - 12rem)); opacity: 0; } } .animate-fly-right { animation: fly-right 0.5s ease-in forwards; } @keyframes fly-left { from { transform: translateX(0); opacity: 1; } to { transform: translateX(calc(-50vw + 12rem)); opacity: 0; } } .animate-fly-left { animation: fly-left 0.5s ease-in forwards; } input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; } input[type="number"] { -moz-appearance: textfield; } .animate-fade-in { animation: fade-in 0.5s ease-out; } @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } } @keyframes float-up { from { transform: translateY(0); opacity: 1; } to { transform: translateY(-50px); opacity: 0; } } .animate-float-up { animation: float-up 1.5s ease-out forwards; } .animate-spin-slow { animation: spin 20s linear infinite; } `}</style> </div> ); };

      // --- PUNTO DE ENTRADA DE LA APP ---
      const App = () => {
        return <GameEngine config={mathAdventureConfig} />;
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
</body>
</html>